@page "/appointment"
@model KoiVeterinaryServiceCenter_FE.Pages.Appointment.AppointmentModel
@{
}

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8 col-md-10">
            <div class="card p-4">
                <h2 class="text-center mb-4">Book an Appointment</h2>

                <form method="post" id="appointmentForm" class="needs-validation" novalidate>
                    @Html.AntiForgeryToken() <!-- Include the antiforgery token -->
                    <!-- Customer Information (Read-Only) -->
                    <div class="form-group mb-3">
                        <label for="customerName">Name</label>
                        <input type="text" class="form-control" id="customerName" name="CustomerName" value="@Model.UserInfo?.Extensions?.Data?.UserName ?? " N /A"" readonly />
                    </div>

                    <div class="form-group mb-3">
                        <label for="customerEmail">Email Address</label>
                        <input type="text" class="form-control" id="customerEmail" name="CustomerEmail" value="@Model.UserInfo?.Extensions?.Data?.Email ?? " N /A"" readonly />
                    </div>

                    <div class="form-group mb-3">
                        <label for="customerPhone">Phone Number</label>
                        <input type="text" class="form-control" id="customerPhone" name="CustomerPhone" value="@Model.UserInfo?.Extensions?.Data?.PhoneNumber ?? " N /A"" readonly />
                    </div>

                    <!-- Pet Selection Dropdown -->
                    <div class="form-group mb-3">
                        <label for="petId">Select Your Pet</label>
                        <select class="form-control" id="petId" name="PetId" required>
                            <option value="">-- Select a Pet --</option>
                            @foreach (var pet in Model.Pets)
                            {
                                <option value="@pet.Id">@pet.Name</option>
                            }
                        </select>
                        <div class="invalid-feedback">Please select a pet.</div>
                    </div>

                    <!-- Service Selection Dropdown -->
                    <div class="form-group mb-3">
                        <label for="serviceId">Select a Service</label>
                        <select class="form-control" id="serviceId" name="ServiceId" required>
                            <option value="">-- Select a Service --</option>
                            @foreach (var service in Model.Services)
                            {
                                <option value="@service.Id">@service.Name - @service.BasePrice.ToString("C") (@service.Duration)</option>
                            }
                        </select>
                        <div class="invalid-feedback">Please select a service.</div>
                    </div>

                    <!-- Appointment Date and Time with "Find" Button -->
                    <div class="form-group mb-3">
                        <label for="appointmentDate">Appointment Date & Time</label>
                        <div class="input-group">
                            <input type="datetime-local" class="form-control" id="appointmentDate" name="AppointmentDate" required />
                            <div class="input-group-append">
                                <!-- Ensure type="button" so it doesn't submit the form -->
                                <button type="button" class="btn btn-secondary" id="findAvailableVets">Find</button>
                            </div>
                        </div>
                        <div class="invalid-feedback">Please select a valid date and time.</div>
                    </div>

                    <!-- Veterinarian Selection Dropdown (Initially hidden, updated with AJAX) -->
                    <div class="form-group mb-3" id="vetSelectionContainer" style="display: none;">
                        <label for="vetId">Select a Veterinarian</label>
                        <select class="form-control" id="vetId" name="VetId" required>
                            <option value="">-- Select a Veterinarian --</option>
                        </select>
                        <div class="invalid-feedback">Please select a veterinarian.</div>
                    </div>

                    <!-- Submit Button -->
                    <button type="submit" class="btn btn-primary btn-block" id="submitAppointment">Book Appointment</button>

                    <!-- Success/Error Message Display -->
                    @if (TempData["SuccessMessage"] != null)
                    {
                        <div class="alert alert-success mt-3">@TempData["SuccessMessage"]</div>
                    }
                    @if (TempData["ErrorMessage"] != null)
                    {
                        <div class="alert alert-danger mt-3">@TempData["ErrorMessage"]</div>
                    }
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function () {
            function fetchAvailableVets(selectedDate) {
                $.ajax({
                    url: '/appointment?handler=FindAvailableVets', // Hardcoded URL to target the handler
                    type: 'POST',
                    headers: {
                        'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val() // Include antiforgery token
                    },
                    data: { selectedDate: selectedDate },
                    success: function (response) {
                        $('#vetSelectionContainer').html(response).show(); // Display the dropdown with vets
                    },
                    error: function (xhr, status, error) {
                        console.error("An error occurred:", xhr.responseText || error);
                        alert("An error occurred while fetching available veterinarians. Please try again.");
                    }
                });
            }

            $('#findAvailableVets').click(function (e) {
                e.preventDefault(); // Prevent any default behavior for safety
                const selectedDate = $('#appointmentDate').val();
                if (selectedDate) {
                    fetchAvailableVets(selectedDate);
                } else {
                    alert("Please select a date and time.");
                }
            });
        });
    </script>
}
